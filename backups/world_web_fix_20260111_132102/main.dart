import \'package:flutter/foundation.dart\';\nimport \'package:flutter/material.dart\';\nimport \'package:shared_preferences/shared_preferences.dart\';\nimport \'package:web_socket_channel/web_socket_channel.dart\';\nimport \'package:flutter/scheduler.dart\';\nimport \'package:http/http.dart\' as http;\nimport \'dart:convert\';\nimport \'dart:async\';\nimport \'dart:ui\';\nimport \'pages/map_debug_page.dart\';\nimport \'app_config.dart\';\n\nvoid main() {\n  runApp(const MyApp());\n}\n\nclass MyApp extends StatelessWidget {\n  const MyApp({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: \'MM2R MMO\',\n      theme: ThemeData(\n        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),\n        useMaterial3: true,\n      ),\n      home: const HomePage(),\n    );\n  }\n}\n\nclass HomePage extends StatelessWidget {\n  const HomePage({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\'MM2R MMO - S1\'),\n        backgroundColor: Theme.of(context).colorScheme.inversePrimary,\n      ),\n      body: Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: <Widget>[\n            ElevatedButton(\n              onPressed: () {\n                Navigator.push(\n                  context,\n                  MaterialPageRoute(builder: (context) => const WorldPage()),\n                );\n              },\n              child: const Text(\'ËøõÂÖ•‰∏ñÁïå\'),\n            ),\n            const SizedBox(height: 20),\n            ElevatedButton(\n              onPressed: () {\n                Navigator.push(\n                  context,\n                  MaterialPageRoute(builder: (context) => const SettingsPage()),\n                );\n              },\n              child: const Text(\'ËÆæÁΩÆ\'),\n            ),\n             const SizedBox(height: 20),\n            ElevatedButton(\n              onPressed: () {\n                Navigator.push(\n                  context,\n                  MaterialPageRoute(builder: (context) => const MapDebugPage()),\n                );\n              },\n              child: const Text(\'Âú∞ÂõæË∞ÉËØï MapDebug\'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass Player {\n  String id;\n  String name;\n  Color color;\n  Offset currentPos;\n  Offset targetPos;\n  int lastUpdate;\n\n  Player({\n    required this.id,\n    required this.name,\n    required this.color,\n    required this.currentPos,\n    required this.targetPos,\n    required this.lastUpdate,\n  });\n\n  static Player fromJson(dynamic data) {\n    final colorStr = (data[\'color\'] as String).replaceAll(\'#\', \'\');\n    return Player(\n      id: data[\'id\'],\n      name: data[\'name\'],\n      color: Color(int.parse(\'ff$colorStr\', radix: 16)),\n      currentPos: Offset(data[\'x\'].toDouble(), data[\'y\'].toDouble()),\n      targetPos: Offset(data[\'x\'].toDouble(), data[\'y\'].toDouble()),\n      lastUpdate: data[\'ts\'],\n    );\n  }\n}\n\nclass WorldPage extends StatefulWidget {\n  const WorldPage({super.key});\n\n  @override\n  State<WorldPage> createState() => _WorldPageState();\n}\n\nclass _WorldPageState extends State<WorldPage> with SingleTickerProviderStateMixin {\n  String _baseUrl = \"\";\n  String _roomId = \"\";\n  String _playerId = \"\";\n  WebSocketChannel? _channel;\n  Ticker? _ticker;\n\n  Map<String, Player> _players = {};\n  Player? _localPlayer;\n\n  String _healthStatus = \'Pending\';\n  String _wsStatus = \'Pending\';\n  String _debugInfo = \'\';\n  Color _healthColor = Colors.orange;\n  Color _wsColor = Colors.orange;\n\n  @override\n  void initState() {\n    super.initState();\n    _runSelfTest(); // Autorun on enter\n    _ticker = createTicker((_) {\n      if(mounted) {\n        setState(() {\n          _updatePlayerPositions();\n        });\n      }\n    });\n    _ticker?.start();\n  }\n\n  Future<void> _runSelfTest() async {\n    // Reset status\n    setState(() {\n      _healthStatus = \'Running...\';\n      _wsStatus = \'Waiting...\';\n      _healthColor = Colors.orange;\n      _wsColor = Colors.orange;\n      _players.clear();\n      _localPlayer = null;\n      _playerId = \'\';\n      _channel?.sink.close();\n      _debugInfo = kIsWeb ? \'Uri.base: \${Uri.base.toString().substring(0, 80)}\' : \'Not on web\';\n    });\n\n    // 1. Force discover and set a valid Base URL\n    final discoveryResult = await AppConfig.discoverAndSetBaseUrl();\n    if (!mounted) return;\n    setState(() {\n       _baseUrl = discoveryResult[\'baseUrl\'] ?? \'Not found\';\n       _debugInfo += \' | currentBaseUrl: $_baseUrl\';\n       if(!discoveryResult[\'success\']){\n          _healthStatus = \'FAIL: \${discoveryResult[\"reason\"]}\';\n          _healthColor = Colors.red;\n          return;\n       }\n    });\n    \n    // 2. Health Check\n    try {\n      final healthUri = Uri.parse(\'$_baseUrl/health\');\n      final response = await http.get(healthUri).timeout(const Duration(seconds: 4));\n      if (response.statusCode == 200) {\n          if(mounted) setState(() { _healthStatus = \'‚úÖ OK\'; _healthColor = Colors.green; });\n      } else {\n          if(mounted) setState(() { _healthStatus = \'‚ö†Ô∏è FAIL (${response.statusCode})\'; _healthColor = Colors.red; });\n          return;\n      }\n    } catch (e) {\n      if(mounted) setState(() { _healthStatus = \'‚ö†Ô∏è FAIL (CORS or Network)\'; _healthColor = Colors.red; });\n      return;\n    }\n    \n    // 3. WebSocket Connection\n    if(mounted) setState(() { _wsStatus = \'Connecting...\'; });\n    _roomId = await AppConfig.getRoomId();\n    final wsUrl = await AppConfig.deriveWsUrl();\n\n    if (wsUrl.isEmpty) {\n      if (mounted) setState(() { _wsStatus = \'‚ö†Ô∏è FAIL (Invalid URL)\'; _wsColor = Colors.red; });\n      return;\n    }\n\n    try {\n      _channel = WebSocketChannel.connect(Uri.parse(wsUrl));\n      if(mounted) setState(() { _wsStatus = \'Connected, waiting...\'; });\n\n      _channel?.stream.listen((message) {\n        if (!mounted) return;\n        final data = jsonDecode(message);\n\n        setState(() {\n          if (data[\'type\'] == \'welcome\') {\n            _playerId = data[\'playerId\'];\n            _updateRoomState(data[\'roomState\']);\n            _localPlayer = _players[_playerId];\n            _wsStatus = \"‚úÖ Welcome received!\";\n            _wsColor = Colors.green;\n          } else if (data[\'type\'] == \'state\') {\n            _updateRoomState(data[\'players\']);\n          }\n        });\n      }, onError: (error) {\n        if (mounted) setState(() { _wsStatus = \'‚ö†Ô∏è Error\'; _wsColor = Colors.red;});\n      }, onDone: () {\n        if (mounted) setState(() { _wsStatus = \'‚ö†Ô∏è Disconnected\'; _wsColor = Colors.red;});\n      });\n    } catch (e) {\n      if (mounted) setState(() { _wsStatus = \'‚ö†Ô∏è FAIL (Cannot connect)\'; _wsColor = Colors.red; });\n    }\n  }\n\n  void _updatePlayerPositions() {\n    final now = DateTime.now().millisecondsSinceEpoch;\n    _players.forEach((id, player) {\n      if (id != _playerId) {\n        final timeDiff = now - player.lastUpdate;\n        final t = (timeDiff / (1000 / 15)).clamp(0.0, 1.0);\n        player.currentPos = Offset.lerp(player.currentPos, player.targetPos, t)!;\n      }\n    });\n  }\n\n  void _updateRoomState(Map<String, dynamic> roomState) {\n    final receivedPlayers = roomState.map((id, data) => MapEntry(id, Player.fromJson(data)));\n    receivedPlayers.forEach((id, newPlayer) {\n      if (_players.containsKey(id)) {\n         final oldPlayer = _players[id]!;\n         if (id != _playerId) {\n             oldPlayer.targetPos = newPlayer.targetPos;\n             oldPlayer.lastUpdate = newPlayer.lastUpdate;\n         }\n      } else {\n         _players[id] = newPlayer;\n      }\n    });\n    _players.removeWhere((id, player) => !receivedPlayers.containsKey(id));\n  }\n\n  void _onPointerMove(PointerMoveEvent event) {\n    if (_channel != null && _localPlayer != null) {\n      final newPos = event.localPosition;\n      _localPlayer!.currentPos = newPos;\n      _localPlayer!.targetPos = newPos;\n      \n      _channel?.sink.add(jsonEncode({\n        \'type\': \'move\',\n        \'x\': newPos.dx,\n        \'y\': newPos.dy,\n      }));\n       if(mounted) setState(() {});\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(title: const Text(\'World\')),\n      body: Column(\n        children: [\n          Container(\n            padding: const EdgeInsets.all(8.0),\n            width: double.infinity,\n            color: Colors.black87,\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text(_debugInfo, style: const TextStyle(fontSize: 9, color: Colors.grey, fontFamily: \'monospace\')),\n                 Row(\n                  children: [\n                    Text(\'Health Check: \', style: TextStyle(color: _healthColor, fontWeight: FontWeight.bold)),\n                    Text(_healthStatus, style: TextStyle(color: _healthColor)),\n                    const Spacer(),\n                    Text(\'WebSocket: \', style: TextStyle(color: _wsColor, fontWeight: FontWeight.bold)),\n                    Text(_wsStatus, style: TextStyle(color: _wsColor)),\n                  ],\n                ),\n                 const SizedBox(height: 4),\n                 Row(\n                   children: [\n                     Text(\'Room: $_roomId | P: ${_players.length}\', style: const TextStyle(fontSize: 11, color: Colors.white70)),\n                     const Spacer(),\n                     SizedBox(\n                       height: 30,\n                       child: ElevatedButton(onPressed: _runSelfTest, child: const Text(\'üîÑ Ëá™Ê£Ä\')),\n                     )\n                   ],\n                 ),\n              ],\n            ),\n          ),\n          Expanded(\n            child: Listener(\n              onPointerMove: _onPointerMove,\n              child: Container(\n                width: double.infinity,\n                height: double.infinity,\n                color: Colors.grey[200],\n                child: CustomPaint(\n                  painter: WorldPainter(players: _players.values.toList()),\n                ),\n              ),\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n  \n  @override\n  void dispose() {\n    _ticker?.dispose();\n    _channel?.sink.close();\n    super.dispose();\n  }\n}\n\nclass WorldPainter extends CustomPainter {\n  final List<Player> players;\n\n  WorldPainter({required this.players});\n\n  @override\n  void paint(Canvas canvas, Size size) {\n    final textPainter = TextPainter(\n      textAlign: TextAlign.center,\n      textDirection: TextDirection.ltr,\n    );\n\n    for (var player in players) {\n      final paint = Paint()..color = player.color;\n      canvas.drawRect(Rect.fromCenter(center: player.currentPos, width: 20, height: 20), paint);\n\n      textPainter.text = TextSpan(\n        text: player.name,\n        style: const TextStyle(color: Colors.black, fontSize: 10),\n      );\n      textPainter.layout();\n      textPainter.paint(canvas, player.currentPos - Offset(textPainter.width / 2, 20));\n    }\n  }\n\n  @override\n  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;\n}\n\nclass SettingsPage extends StatefulWidget {\n  const SettingsPage({super.key});\n\n  @override\n  State<SettingsPage> createState() => _SettingsPageState();\n}\n\nclass _SettingsPageState extends State<SettingsPage> {\n  final TextEditingController _baseUrlController = TextEditingController();\n  final TextEditingController _roomController = TextEditingController();\n  final TextEditingController _nameController = TextEditingController();\n\n  @override\n  void initState() {\n    super.initState();\n    _loadSettings();\n  }\n  \n  @override\n  void dispose() {\n    _baseUrlController.dispose();\n    _roomController.dispose();\n    _nameController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _loadSettings() async {\n    _baseUrlController.text = await AppConfig.getHttpBaseUrl();\n    _roomController.text = await AppConfig.getRoomId();\n    _nameController.text = await AppConfig.getPlayerName();\n    setState(() {});\n  }\n\n  Future<void> _saveSettings() async {\n    await AppConfig.setHttpBaseUrl(_baseUrlController.text);\n    await AppConfig.setRoomId(_roomController.text);\n    await AppConfig.setPlayerName(_nameController.text);\n    if (mounted) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text(\'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò\')),\n      );\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\'ËÆæÁΩÆ\'),\n      ),\n      body: Padding(\n        padding: const EdgeInsets.all(16.0),\n        child: SingleChildScrollView(\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              const Text(\'ÁΩëÁªúËÆæÁΩÆ\', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),\n              const SizedBox(height: 10),\n              TextField(\n                controller: _baseUrlController,\n                decoration: const InputDecoration(\n                  labelText: \'ÂêéÁ´ØÂú∞ÂùÄ (HTTP Base URL)\',\n                  border: OutlineInputBorder(),\n                  hintText: \'https://...\',\n                ),\n              ),\n              const SizedBox(height: 20),\n              const Text(\'Áé©ÂÆ∂ËÆæÁΩÆ\', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),\n              const SizedBox(height: 10),\n              TextField(\n                controller: _roomController,\n                decoration: const InputDecoration(\n                  labelText: \'ÊàøÈó¥Âêç\',\n                  border: OutlineInputBorder(),\n                ),\n              ),\n              const SizedBox(height: 10),\n              TextField(\n                controller: _nameController,\n                decoration: const InputDecoration(\n                  labelText: \'Áé©ÂÆ∂Âêç\',\n                  border: OutlineInputBorder(),\n                ),\n              ),\n              const SizedBox(height: 20),\n              ElevatedButton(\n                onPressed: _saveSettings,\n                child: const Text(\'‰øùÂ≠ò\'),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n}\n